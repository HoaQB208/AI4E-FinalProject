@page "/"
@using FinalProject.Core.Data
@using FinalProject.Core._Class
@using Newtonsoft.Json
<PageTitle>ThaiHoaPham - FinalProject - AI4E</PageTitle>

<div>
    <label for="stockCode">Symbol</label>
    <input id="stockCode" @bind="stockCode" />
    <button @onclick="Predict">Predict</button>
</div>

<div>
    @result
</div>

@code {
    private string stockCode = "BTCUSDT";
    private string result = "";

    private async void Predict()
    {
        var klines = await Market.Download(stockCode, Interval.H1, null, limit: 30);
        if (klines.Count > 12)
        {
            klines.Remove(klines.Last());

            List<float> pers = klines.Select(kline => (float)PriceUtils.Percent(kline.O, kline.C, 1)).ToList();
            DataRow dataRow = new()
                {
                    C0 = pers[^12],
                    C1 = pers[^11],
                    C2 = pers[^10],
                    C3 = pers[^9],
                    C4 = pers[^8],
                    C5 = pers[^7],
                    C6 = pers[^6],
                    C7 = pers[^5],
                    C8 = pers[^4],
                    C9 = pers[^3],
                    C10 = pers[^2],
                    C11 = pers[^1]
                };
            string data = JsonConvert.SerializeObject(dataRow);
            string url = "https://ai4e-server.azurewebsites.net/api/pre/" + data;
            string resultStr = await new HttpClient().GetStringAsync(url);
            if (!string.IsNullOrEmpty(resultStr))
            {
                Prediction? pre = JsonConvert.DeserializeObject<Prediction>(resultStr);
                if (pre != null)
                {
                    var last = klines.Last();
                    decimal closePrice = last.C * (1 + (decimal)pre.Score);

                    string klineColor = pre.Score >= 0 ? "Green" : "Red";
                    result = $"Close Price: {closePrice:0.00000000}\nColor: {klineColor}";
                    StateHasChanged();
                }
            }
        }
    }
}